(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{5139:function(e,t,s){Promise.resolve().then(s.bind(s,3275))},3275:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return f}});var a=s(7437),r=s(2265);let l="auth_token";function n(){try{if(!window.localStorage)return!1;let e="__probe__";return window.localStorage.setItem(e,e),window.localStorage.removeItem(e),!0}catch(e){return!1}}async function i(){if(!n())throw Error("storage-unavailable");try{let e=window.localStorage.getItem(l);if(null===e)return null;if("string"!=typeof e)throw Error("invalid-token-format");let t=e.trim();return""===t?null:t}catch(e){throw console.error("authStorage.getToken error",e),e}}async function c(e){if("string"!=typeof e||""===e.trim())throw Error("invalid-token");if(!n())throw Error("storage-unavailable");try{window.localStorage.setItem(l,e)}catch(e){throw console.error("authStorage.saveToken error",e),e}}async function o(){if(!n())throw Error("storage-unavailable");try{window.localStorage.removeItem(l)}catch(e){throw console.error("authStorage.removeToken error",e),e}}async function d(e){let t=await fetch("/api/bcs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"createOrder",...e})}),s=await t.json();if(!s.success)throw Error(s.error||"Ошибка создания заявки");return s.data}function u(e){let{instrumentId:t,instrumentName:s,instrumentTicker:l,onClose:n,onSuccess:i,onError:c}=e,[o,u]=(0,r.useState)("market"),[m,h]=(0,r.useState)(""),[x,f]=(0,r.useState)(""),[g,b]=(0,r.useState)(!1),[p,y]=(0,r.useState)(null),j=m&&parseInt(m)>0&&("market"===o||x&&parseFloat(x)>0),v=async e=>{if(j){b(!0);try{let s=await d({instrumentId:t,side:e,type:o,quantity:parseInt(m),price:"limit"===o?parseFloat(x):void 0});y({success:!0,message:"Заявка ".concat(s.orderId," успешно создана")}),null==i||i(s)}catch(t){let e=t instanceof Error?t.message:"Ошибка создания заявки";y({success:!1,message:e}),null==c||c(e)}finally{b(!1)}}};return p?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-xl p-6 w-full max-w-md text-center",children:[(0,a.jsx)("div",{className:"text-4xl mb-4 ".concat(p.success?"text-green-500":"text-red-500"),children:p.success?"✓":"✗"}),(0,a.jsx)("h2",{className:"text-xl font-bold mb-2",children:p.success?"Успешно":"Ошибка"}),(0,a.jsx)("p",{className:"text-gray-600 mb-6",children:p.message}),(0,a.jsx)("button",{onClick:n,className:"w-full py-3 bg-blue-500 text-white rounded-lg font-medium",children:"Вернуться в портфель"})]})}):(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-xl p-6 w-full max-w-md",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold",children:s}),(0,a.jsx)("span",{className:"text-gray-500",children:l})]}),(0,a.jsx)("button",{onClick:n,className:"text-gray-400 text-2xl",children:"\xd7"})]}),(0,a.jsx)("div",{className:"flex gap-2 mb-4",children:["market","limit"].map(e=>(0,a.jsx)("button",{onClick:()=>u(e),className:"flex-1 py-2 rounded-lg ".concat(o===e?"bg-blue-500 text-white":"bg-gray-100"),children:"market"===e?"Рыночная":"Лимитная"},e))}),(0,a.jsx)("input",{type:"number",placeholder:"Количество, шт.",value:m,onChange:e=>h(e.target.value),min:"1",className:"w-full p-3 border rounded-lg mb-3"}),"limit"===o&&(0,a.jsx)("input",{type:"number",placeholder:"Цена",value:x,onChange:e=>f(e.target.value),step:"0.01",min:"0.01",className:"w-full p-3 border rounded-lg mb-3"}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{onClick:()=>v("buy"),disabled:!j||g,className:"flex-1 py-3 bg-green-500 text-white rounded-lg font-medium disabled:opacity-50",children:g?"...":"Купить"}),(0,a.jsx)("button",{onClick:()=>v("sell"),disabled:!j||g,className:"flex-1 py-3 bg-red-500 text-white rounded-lg font-medium disabled:opacity-50",children:g?"...":"Продать"})]})]})})}function m(){let[e,t]=(0,r.useState)([]),[s,l]=(0,r.useState)(""),[n,i]=(0,r.useState)([]),[c,o]=(0,r.useState)(!0),[d,m]=(0,r.useState)(null),[h,x]=(0,r.useState)(null),f=(0,r.useCallback)(async()=>{try{var e;let s=await fetch("/api/bcs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"accounts"})}),a=await s.json();a.success&&(null===(e=a.data)||void 0===e?void 0:e.length)&&(t(a.data),l(a.data[0].id))}catch(e){m("Ошибка загрузки счетов")}},[]),g=(0,r.useCallback)(async()=>{if(s){o(!0);try{var e;let t=await fetch("/api/bcs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"portfolio",accountId:s})}),a=await t.json();a.success?i((null===(e=a.data)||void 0===e?void 0:e.positions)||[]):m(a.error||"Ошибка загрузки портфеля")}catch(e){m("Ошибка загрузки портфеля")}finally{o(!1)}}},[s]);(0,r.useEffect)(()=>{f()},[f]),(0,r.useEffect)(()=>{g()},[g]);let b=e=>{x({instrumentId:e.instrumentId,name:e.name,ticker:e.ticker})};return d?(0,a.jsx)("div",{className:"p-4 text-red-500",children:d}):c?(0,a.jsx)("div",{className:"p-4",children:"Загрузка..."}):(0,a.jsxs)("div",{className:"p-4",children:[e.length>1&&(0,a.jsx)("select",{value:s,onChange:e=>l(e.target.value),className:"w-full p-2 border rounded mb-4",children:e.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsxs)("div",{className:"space-y-2",children:[n.map(e=>{var t,s,r;return(0,a.jsx)("div",{onClick:()=>b(e),className:"p-4 bg-white rounded-lg shadow cursor-pointer hover:bg-gray-50",children:(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:e.name}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[e.ticker," \xb7 ",e.quantity," шт."]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"font-medium",children:[(null!==(t=e.totalValue)&&void 0!==t?t:0).toLocaleString("ru-RU")," ₽"]}),(0,a.jsxs)("div",{className:e.profitLoss>=0?"text-green-500":"text-red-500",children:[e.profitLoss>=0?"+":"",(null!==(s=e.profitLoss)&&void 0!==s?s:0).toLocaleString("ru-RU")," ₽ (",(null!==(r=e.profitLossPercent)&&void 0!==r?r:0).toFixed(2),"%)"]})]})]})},e.instrumentId)}),0===n.length&&(0,a.jsx)("div",{className:"text-gray-500 text-center py-8",children:"Портфель пуст"})]}),h&&(0,a.jsx)(u,{instrumentId:h.instrumentId,instrumentName:h.name,instrumentTicker:h.ticker,onClose:()=>x(null),onSuccess:()=>{x(null),g()},onError:e=>console.error("Order error:",e)})]})}let h=e=>{let{storageError:t,onSaved:s}=e,[l,n]=(0,r.useState)(""),[i,o]=(0,r.useState)(!1),[d,u]=(0,r.useState)(null);return(0,a.jsx)("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-xl p-6 w-full max-w-md shadow-lg",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold mb-2 text-center",children:"Добавить токен"}),(0,a.jsx)("p",{className:"text-gray-500 text-center mb-6",children:"Введите ваш API токен для доступа к торговле"}),t&&(0,a.jsxs)("div",{className:"bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm",children:["Ошибка хранилища: ",t]}),(0,a.jsx)("input",{"aria-label":"auth-token",value:l,onChange:e=>n(e.target.value),placeholder:"Вставьте ваш токен",className:"w-full p-3 border rounded-lg mb-4"}),(0,a.jsx)("button",{onClick:async()=>{if(u(null),!l||""===l.trim()){u("Токен не может быть пустым");return}o(!0);try{await c(l.trim()),s()}catch(e){console.error("Failed to save token",e),u(e.message||"Ошибка сохранения")}finally{o(!1)}},disabled:i,className:"w-full py-3 bg-blue-500 text-white rounded-lg font-medium disabled:opacity-50",children:i?"Сохранение...":"Сохранить"}),d&&(0,a.jsx)("div",{className:"bg-red-50 text-red-600 p-3 rounded-lg mt-4 text-sm",children:d})]})})};var x=()=>{let[e,t]=(0,r.useState)(!0),[s,l]=(0,r.useState)(null),[n,c]=(0,r.useState)(!1);return((0,r.useEffect)(()=>{let e=!0;return(async()=>{try{let t=await i();if(!e)return;t&&c(!0)}catch(e){l((null==e?void 0:e.message)||"storage-error")}finally{e&&t(!1)}})(),()=>{e=!1}},[]),e)?(0,a.jsx)("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:(0,a.jsx)("div",{className:"text-gray-500",children:"Загрузка..."})}):n?(0,a.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,a.jsxs)("div",{className:"bg-white shadow-sm p-4 flex justify-between items-center",children:[(0,a.jsx)("h1",{className:"text-xl font-bold",children:"Портфель"}),(0,a.jsx)("button",{onClick:async()=>{try{await o(),c(!1)}catch(e){console.error("Logout failed",e)}},className:"text-red-500 text-sm",children:"Выйти"})]}),(0,a.jsx)(m,{})]}):(0,a.jsx)(h,{storageError:s,onSaved:()=>c(!0)})};function f(){return(0,a.jsx)(x,{})}}},function(e){e.O(0,[971,23,744],function(){return e(e.s=5139)}),_N_E=e.O()}]);